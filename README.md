# 360cam_gnss

## 概要
Raspberry Pi用のステレオスコピック360度カメラシステムとGNSS（全地球航法衛星システム）統合

## 機能
- ステレオスコピックカメラ撮影（左右2台のカメラ）
- デュアルフィッシュアイカメラサポート（全天球変換）
  - 220度超広角カメラに最適化
- 複数の表示モード
  - ステレオカメラ: 左右並列、左のみ、右のみ、アナグリフ3D
  - デュアルフィッシュアイ: フィッシュアイ、全天球展開（equirectangular）
- 動画録画と静止画撮影
- ウェブインターフェース（Flaskベース）でのカメラ制御
- デバッグモード（パラメータリアルタイム調整機能付き）

## インストール方法

### 依存パッケージ
```bash
sudo apt-get update
sudo apt-get install -y python3-picamera python3-opencv gpsd gpsd-clients python3-pip mp4box
```

### Python依存関係（Python 3.7用）
```bash
pip3 install -r py37_requirements.txt
```

## 使用方法

### コマンドラインでの使用
```bash
# ステレオカメラを起動して録画する
python3 start_camera.py

# デュアルフィッシュアイカメラを起動する
python3 start_dual_fisheye.py

# デバッグモードでデュアルフィッシュアイカメラを起動（パラメータ調整用）
python3 debug_dual_fisheye.py

# 使用可能なコマンド:
# r - 録画開始/停止
# d - 表示モード切替
# p - 写真撮影
# q - 終了
# s - パラメータ保存（デバッグモード時のみ）
```

### ウェブアプリの使用
```bash
# ステレオカメラ用のウェブインターフェースを起動
python3 web_camera_app.py

# デュアルフィッシュアイカメラ用のウェブインターフェースを起動
python3 web_dual_fisheye_app.py

# デバッグモードのウェブインターフェースを起動（パラメータ調整用）
python3 web_debug_fisheye.py
```

ブラウザで以下のURLにアクセスしてください：
```
# ステレオカメラ用ウェブインターフェース
http://ラズパイのIPアドレス:8080

# デュアルフィッシュアイカメラ用ウェブインターフェース
http://ラズパイのIPアドレス:8081

# デバッグモード用ウェブインターフェース
http://ラズパイのIPアドレス:8082
```

ウェブアプリの機能:
- カメラ起動/停止
- 録画開始/停止
- 写真撮影
- 表示モード切替
- リアルタイムカメラプレビュー
- パラメータ調整（デバッグモード時）

## デュアルフィッシュアイカメラの全天球変換について
デュアルフィッシュアイカメラのサポートにより、2つのフィッシュアイレンズ画像をリアルタイムで全天球（equirectangular）形式に変換して表示・録画できます。この変換処理はOpenCVのremap関数を使用して実装されています。設定パラメータは`config.py`の`DUAL_FISHEYE_CONFIG`セクションで調整可能です。

デュアルフィッシュアイカメラクラスは、既存のCameraクラスを継承して実装されており、基本的なカメラ操作はステレオカメラと同じインターフェースで利用できます。

### 220度超広角カメラのサポート
このシステムは220度の視野角を持つ超広角カメラに最適化されています。通常のフィッシュアイカメラ（180度）よりも広い視野をカバーできるよう、マッピングアルゴリズムを特別に調整しています。

- 220度の視野角に対応したスケーリングファクター
- 視野の重複領域でのスムーズなブレンディング
- 広角カメラ特有の歪みを考慮した変換処理

### パラメータ調整（デバッグモード）
デュアルフィッシュアイ変換のパラメータは、コマンドラインまたはウェブインターフェースからリアルタイムで調整できます。これにより、使用するカメラの特性に合わせた最適なパラメータを見つけることができます。

#### デバッグモードの使い方
1. コマンドラインから：
   ```bash
   python3 debug_dual_fisheye.py
   ```
   - 調整したパラメータを保存するには「s」キーを押します。

2. ウェブブラウザから：
   ```bash
   python3 web_debug_fisheye.py
   ```
   - ブラウザで http://ラズパイのIPアドレス:8082 にアクセスします。
   - スライダーを使ってパラメータをリアルタイムで調整できます。
   - 「パラメータ保存」ボタンを押して設定を保存できます。

#### 調整可能なパラメータ
- **CX1, CY1**: 左フィッシュアイの中心座標
- **CX2, CY2**: 右フィッシュアイの中心座標
- **Radius Scale**: フィッシュアイ半径のスケーリング係数
- **Field of View**: カメラの視野角（度）
- **Overlap**: フィッシュアイ間の重複領域（度）

#### 表示モード
デバッグモードでは、以下の表示モードを切り替えられます：
- **元映像**: キャリブレーションマーカー付きのオリジナル映像
- **全天球変換**: 変換後の全天球（equirectangular）映像のみ
- **デバッグビュー**: 上部に元映像とマーカー、下部に変換後の映像を表示

#### パラメータ最適化のヒント
1. まず正しい**中心座標**（CX1, CY1, CX2, CY2）を設定します。中心点がずれていると、全体的な歪みが大きくなります。
2. 適切な**半径スケール**（Radius Scale）を設定します。範囲は0.6〜1.2が一般的です。
3. カメラの**視野角**（Field of View）を調整します。220度カメラであれば210〜230度の間で試してみてください。
4. **重複領域**（Overlap）を微調整して、左右の映像の繋ぎ目を滑らかにします。

最適なパラメータが見つかったら、保存したパラメータファイルを確認し、`config.py`の`DUAL_FISHEYE_CONFIG`セクションに手動で値を設定します。

### デュアルフィッシュアイカメラの設定
デュアルフィッシュアイカメラの設定は`config.py`ファイルの以下のパラメータで調整できます：

```python
DUAL_FISHEYE_CONFIG = {
    'width': 1440,                    # 画像の幅
    'height': 720,                    # 画像の高さ
    'cx1': 360,                       # 左フィッシュアイの中心X座標
    'cy1': 360,                       # 左フィッシュアイの中心Y座標
    'cx2': 1080,                      # 右フィッシュアイの中心X座標
    'cy2': 360,                       # 右フィッシュアイの中心Y座標
    'radius_scale': 1.2,              # フィッシュアイの半径スケール（220度対応に拡大）
    'equ_height_ratio': 0.5,          # 全天球出力の高さ比率
    'field_of_view': 220,             # カメラの視野角（度）
    'fisheye_overlap': 10,            # フィッシュアイ画像の重複領域（度）
}
```

## ファイル構成
- `camera.py` - ステレオカメラクラスの実装
- `dual_fisheye_camera.py` - デュアルフィッシュアイカメラクラス（Cameraクラスを継承）
- `config.py` - 設定ファイル
- `start_camera.py` - ステレオカメラ用のシンプルなコマンドラインインターフェース
- `start_dual_fisheye.py` - デュアルフィッシュアイカメラ用のコマンドラインインターフェース
- `web_camera_app.py` - ステレオカメラ用のFlaskベースのウェブインターフェース
- `web_dual_fisheye_app.py` - デュアルフィッシュアイカメラ用のFlaskベースのウェブインターフェース
- `debug_dual_fisheye.py` - デュアルフィッシュアイカメラのデバッグ用コマンドラインツール
- `web_debug_fisheye.py` - デュアルフィッシュアイカメラのデバッグ用ウェブインターフェース
- `camera_app.py` - Fletベースのグラフィカルインターフェース（Python 3.9以上が必要）

## 実装詳細
デュアルフィッシュアイカメラは、基本のCameraクラスを継承して拡張しています。主な拡張機能は次の通りです：

1. **全天球変換機能**: フィッシュアイ画像から全天球（equirectangular）形式への変換
2. **処理スレッド**: リアルタイムで画像変換を行うための独立した処理スレッド
3. **表示モード**: フィッシュアイと全天球の2種類の表示モードを切り替え可能
4. **デバッグモード**: カメラパラメータをリアルタイムで調整・最適化

Camera親クラスの機能をほとんどそのまま利用し、全天球変換の部分のみを追加実装しています。

## Python 3.7での実行について
Python 3.7で実行する場合は、以下の点に注意してください：
- `web_camera_app.py`、`web_dual_fisheye_app.py`、`web_debug_fisheye.py`はPython 3.7と互換性があります
- 依存パッケージをインストールする際には `py37_requirements.txt` を使用してください
- `camera_app.py`（Fletバージョン）はPython 3.9以上が必要です

## ライセンス
このプロジェクトはGNU General Public License v3.0の下でライセンスされています。